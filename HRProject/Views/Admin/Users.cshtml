

@model IEnumerable<HRProject.Models.UserWithRolesViewModel>

@{
    ViewData["Title"] = "Users & Roles";

    var usersList = Model?.ToList() ?? new List<HRProject.Models.UserWithRolesViewModel>();
    var totalUsers = usersList.Count;
    var withRoles = usersList.Count(u => u.Roles != null && u.Roles.Any());
    var distinctRoles = usersList
        .Where(u => u.Roles != null)
        .SelectMany(u => u.Roles)
        .Distinct()
        .Count();

    var allRoles = ViewBag.AllRoles as List<string> ?? new List<string>();
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

<style>
    .users-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        border-radius: 0 0 30px 30px;
        box-shadow: 0 12px 35px rgba(0,0,0,0.25);
        margin-bottom: 1.25rem;
        overflow: hidden;
        position: relative;
    }

        .users-hero::before,
        .users-hero::after {
            content: "";
            position: absolute;
            width: 260px;
            height: 260px;
            border-radius: 50%;
            background: rgba(255,255,255,0.12);
        }

        .users-hero::before {
            top: -120px;
            left: -120px;
        }

        .users-hero::after {
            bottom: -140px;
            right: -140px;
        }

    .users-hero-title {
        font-weight: 800;
        font-size: clamp(1.6rem, 2.5vw, 2.3rem);
        line-height: 1.1;
        margin-bottom: .2rem;
    }

    .stat-pill {
        background: rgba(255, 255, 255, 0.12);
        border-radius: 18px;
        padding: .65rem 1rem;
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        font-size: 0.9rem;
        white-space: nowrap;
    }

        .stat-pill strong {
            font-size: 1.05rem;
            font-weight: 800;
            margin-left: .15rem;
        }

    .users-container {
        padding: 0 .75rem 2rem .75rem;
    }

    .user-card {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .avatar-circle {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 800;
        font-size: 1.1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.20);
        flex: 0 0 auto;
    }

    .user-name {
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: .1rem;
        word-break: break-word;
    }

    .user-email {
        font-size: .9rem;
        color: #6c757d;
        word-break: break-word;
    }

    .role-badge-main {
        border-radius: 999px;
        padding: 0.35rem 0.85rem;
        font-size: .8rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: .35rem;
    }

    .badge-status {
        font-size: .75rem;
        border-radius: 999px;
        padding: .2rem .6rem;
    }

    /* Controls should never force overflow on mobile */
    .action-block .form-select {
        min-width: 0 !important;
    }

    /* Avoid horizontal scrolling caused by wide cards */
    body {
        overflow-x: hidden;
    }
</style>

<div class="users-hero">
    <div class="container-fluid px-3 px-md-4 py-4 py-md-5">
        <div class="d-flex align-items-start gap-3">
            <div class="flex-shrink-0">
                <i class="bi bi-people-fill" style="font-size:2.5rem;"></i>
            </div>
            <div>
                <div class="users-hero-title">Users & Roles</div>
                <div class="small opacity-75">
                    Manage and oversee all users in the system with their assigned roles and permissions.
                </div>
            </div>
        </div>

        <div class="mt-4 d-flex flex-wrap gap-2">
            <span class="stat-pill">
                <i class="bi bi-person-lines-fill"></i>
                Total Users: <strong>@totalUsers</strong>
            </span>
            <span class="stat-pill">
                <i class="bi bi-shield-lock"></i>
                With Roles: <strong>@withRoles</strong>
            </span>
            <span class="stat-pill">
                <i class="bi bi-diagram-3"></i>
                Active Role Types: <strong>@distinctRoles</strong>
            </span>
        </div>
    </div>
</div>

<div class="container-fluid users-container">

    @if (TempData["UsersMessage"] != null)
    {
        <div class="alert alert-info mb-3">
            @TempData["UsersMessage"]
        </div>
    }

    @if (!usersList.Any())
    {
        <div class="text-center text-muted py-5">
            <i class="bi bi-clipboard-x display-5 d-block mb-2"></i>
            No users found.
        </div>
    }
    else
    {
        @foreach (var u in usersList)
        {
            var primaryRole = u.Roles?.FirstOrDefault();
            var initial = ((u.FullName ?? u.Email ?? "?").Trim().FirstOrDefault().ToString().ToUpper());

            <div class="user-card mb-3">
                <div class="p-3 p-md-4">
                    <div class="row g-3 align-items-start align-items-lg-center">

                        <!-- LEFT: User identity -->
                        <div class="col-12 col-lg-5">
                            <div class="d-flex align-items-center gap-3">
                                <div class="avatar-circle">@initial</div>
                                <div>
                                    <div class="user-name">
                                        @(string.IsNullOrWhiteSpace(u.FullName) ? u.Email : u.FullName)
                                    </div>
                                    <div class="user-email">
                                        <i class="bi bi-envelope me-1"></i>@u.Email
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- MIDDLE: role + status -->
                        <div class="col-12 col-lg-3">
                            <div class="d-flex flex-wrap align-items-center gap-2">
                                @if (!string.IsNullOrEmpty(primaryRole))
                                {
                                    <span class="role-badge-main bg-primary text-white">
                                        <i class="bi bi-shield-check"></i> @primaryRole
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary-subtle text-secondary badge-status">
                                        No role
                                    </span>
                                }

                                @if (u.IsLockedOut)
                                {
                                    <span class="badge bg-danger badge-status">Deactivated</span>
                                }
                                else
                                {
                                    <span class="badge bg-success badge-status">Active</span>
                                }
                            </div>
                        </div>

                        <!-- RIGHT: actions -->
                        <div class="col-12 col-lg-4 action-block">
                            <div class="row g-2">

                                <!-- Update role -->
                                <div class="col-12">
                                    <form asp-action="UpdateUserRole" asp-controller="Admin" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="userId" value="@u.UserId" />

                                        <div class="d-grid d-md-flex gap-2">
                                            <select name="newRole" class="form-select form-select-sm w-100">
                                                <option value="">(No role)</option>
                                                @foreach (var roleName in allRoles)
                                                {
                                                    <option value="@roleName" selected="@(primaryRole == roleName)">
                                                        @roleName
                                                    </option>
                                                }
                                            </select>

                                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                                Update
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Activate / Deactivate -->
                                <div class="col-12">
                                    <form asp-action="ToggleUserActive" asp-controller="Admin" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="userId" value="@u.UserId" />

                                        <div class="d-grid">
                                            <button type="submit"
                                                    class="btn btn-sm @(u.IsLockedOut ? "btn-success" : "btn-outline-danger")">
                                                @(u.IsLockedOut ? "Activate" : "Deactivate")
                                            </button>
                                        </div>
                                    </form>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>
            </div>
        }
    }
</div>
