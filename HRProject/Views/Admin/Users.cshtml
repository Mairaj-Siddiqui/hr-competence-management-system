@model IEnumerable<HRProject.Models.UserWithRolesViewModel>

@{
    ViewData["Title"] = "Users & Roles";
    var usersList = Model?.ToList() ?? new List<HRProject.Models.UserWithRolesViewModel>();
    var totalUsers = usersList.Count;
    var withRoles = usersList.Count(u => u.Roles != null && u.Roles.Any());
    var distinctRoles = usersList
        .Where(u => u.Roles != null)
        .SelectMany(u => u.Roles)
        .Distinct()
        .Count();

    var allRoles = ViewBag.AllRoles as List<string> ?? new List<string>();
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    .users-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        padding: 2.5rem 3rem 1.5rem 3rem;
        border-radius: 0 0 30px 30px;
        box-shadow: 0 12px 35px rgba(0,0,0,0.25);
        margin-bottom: 2.5rem;
    }

    .users-hero-title {
        font-weight: 800;
        font-size: 2.3rem;
    }

    .stat-pill {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 18px;
        padding: .75rem 1.25rem;
        margin-right: .75rem;
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        font-size: 0.9rem;
    }

    .stat-pill strong {
        font-size: 1.1rem;
    }

    .users-container {
        margin-top: -1rem;
        padding: 0 2rem 2rem 2rem;
    }

    .user-card {
        background: #ffffff;
        border-radius: 20px;
        padding: 1.25rem 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }

    .user-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .avatar-circle {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 700;
        font-size: 1.1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    .user-name {
        font-weight: 600;
        font-size: 1rem;
    }

    .user-email {
        font-size: .9rem;
        color: #6c757d;
    }

    .role-badge-main {
        border-radius: 999px;
        padding: 0.35rem 0.9rem;
        font-size: .8rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        margin-right: .5rem;
    }

    .role-badge-main i {
        font-size: .9rem;
    }

    .user-actions {
        display: flex;
        align-items: center;
        gap: .75rem;
    }

    .form-inline {
        display: inline-flex;
        align-items: center;
        gap: .5rem;
    }

    .form-inline select {
        min-width: 140px;
    }

    .badge-status {
        font-size: .75rem;
        border-radius: 999px;
        padding: .2rem .6rem;
    }
</style>

<div class="users-hero">
    <div class="d-flex align-items-center mb-2">
        <div class="me-2">
            <i class="bi bi-people-fill" style="font-size:2.5rem;"></i>
        </div>
        <div>
            <div class="users-hero-title">Users & Roles</div>
            <div class="small">
                Manage and oversee all users in the system with their assigned roles and permissions.
            </div>
        </div>
    </div>

    <div class="mt-3">
        <span class="stat-pill">
            <i class="bi bi-person-lines-fill"></i>
            Total Users: <strong>@totalUsers</strong>
        </span>
        <span class="stat-pill">
            <i class="bi bi-shield-lock"></i>
            With Roles: <strong>@withRoles</strong>
        </span>
        <span class="stat-pill">
            <i class="bi bi-diagram-3"></i>
            Active Role Types: <strong>@distinctRoles</strong>
        </span>
    </div>
</div>

<div class="container-fluid users-container">

    @if (TempData["UsersMessage"] != null)
    {
        <div class="alert alert-info mb-3">
            @TempData["UsersMessage"]
        </div>
    }

    @if (!usersList.Any())
    {
        <div class="text-center text-muted py-5">
            <i class="bi bi-clipboard-x display-5 d-block mb-2"></i>
            No users found.
        </div>
    }
    else
    {
        @foreach (var u in usersList)
        {
            var primaryRole = u.Roles?.FirstOrDefault();

            <div class="user-card">
                <div class="user-left">
                    <div class="avatar-circle">
                        @((u.FullName ?? u.Email ?? "?").Trim().FirstOrDefault().ToString().ToUpper())
                    </div>
                    <div>
                        <div class="user-name">
                            @(string.IsNullOrWhiteSpace(u.FullName) ? u.Email : u.FullName)
                        </div>
                        <div class="user-email">
                            <i class="bi bi-envelope me-1"></i> @u.Email
                        </div>
                    </div>
                </div>

                <div class="user-actions">

                    <!-- Current role badge -->
                    <div>
                        @if (!string.IsNullOrEmpty(primaryRole))
                        {
                            <span class="role-badge-main bg-primary text-white">
                                <i class="bi bi-shield-check"></i> @primaryRole
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-secondary-subtle text-secondary badge-status">
                                No role
                            </span>
                        }

                        @if (u.IsLockedOut)
                        {
                            <span class="badge bg-danger badge-status">Deactivated</span>
                        }
                        else
                        {
                            <span class="badge bg-success badge-status">Active</span>
                        }
                    </div>

                    <!-- Form: update role -->
                    <form asp-action="UpdateUserRole" asp-controller="Admin" method="post" class="form-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="userId" value="@u.UserId" />

                        <select name="newRole" class="form-select form-select-sm">
                            <option value="">(No role)</option>
                            @foreach (var roleName in allRoles)
                            {
                                <option value="@roleName" selected="@(primaryRole == roleName)">
                                    @roleName
                                </option>

                            }
                        </select>

                        <button type="submit" class="btn btn-sm btn-outline-primary">
                            Update
                        </button>
                    </form>

                    <!-- Form: activate/deactivate -->
                    <form asp-action="ToggleUserActive" asp-controller="Admin" method="post" class="form-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="userId" value="@u.UserId" />

                        <button type="submit"
                                class="btn btn-sm @(u.IsLockedOut ? "btn-success" : "btn-outline-danger")">
                            @(u.IsLockedOut ? "Activate" : "Deactivate")
                        </button>
                    </form>

                </div>
            </div>
        }
    }
</div>
